<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Forteresse â€” Proto (v0.2-fix MOVE)</title>
  <style>
    :root{ --grid:9; --bg:#0f1116; --panel:#151a23; --text:#e8eef7; --muted:#8ea0bf;
           --tile:#1b2230; --tile2:#1f2736; --orange:#e6a23c; --blue:#2c7be5; --red:#e55353; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,#0f1116,#0c111a);color:var(--text);
         font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .app{max-width:1240px;margin:14px auto;padding:0 12px;display:grid;gap:12px;
         grid-template-columns:300px 1fr 320px}
    .card{background:var(--panel);border:1px solid #232a3b;border-radius:16px;overflow:hidden;
          box-shadow:0 12px 28px rgba(0,0,0,.35)}
    .card h2{margin:0;padding:10px 12px;font-size:16px;border-bottom:1px solid #1e2533;background:#121722}
    .pad{padding:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .sep{height:1px;background:#20283b;margin:10px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#101827;border:1px solid #253045;
          border-radius:999px;padding:6px 10px}
    .btn{appearance:none;border:1px solid #2a3246;background:#192031;color:#cfe1ff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#3563c9,#234db0);border-color:#2048a0;color:#fff;font-weight:600}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .log{height:220px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;background:#111622;
         border-radius:10px;padding:10px;border:1px solid #222a3a}

    /* Board */
    .board-wrap{display:grid;place-items:center;padding:12px}
    #board{display:grid;grid-template-columns:repeat(9,1fr);grid-template-rows:repeat(9,1fr);
           gap:2px;width:96vmin;max-width:680px;aspect-ratio:1/1;background:#0b0f16;border:1px solid #1c2433;border-radius:14px;padding:8px}
    .cell{border-radius:8px;position:relative;display:grid;place-items:center;user-select:none}
    .cell.play{background:linear-gradient(180deg,var(--tile),var(--tile2));border:1px solid #24304a}
    .cell.invalid{background:transparent;border:1px dashed #1c2233;opacity:.25}
    .cell.orange{outline:2px solid var(--orange)}
    .cell.bzone{box-shadow:inset 0 0 0 2px rgba(44,123,229,.35)}
    .cell.rzone{box-shadow:inset 0 0 0 2px rgba(229,83,83,.35)}
    .cell.blocked::after{content:'';position:absolute;inset:6px;border-radius:6px;background:repeating-linear-gradient(45deg,#3a4356 0 6px,#151b27 6px 12px);opacity:.8;outline:2px solid #3a445a}
    .coord{position:absolute;right:4px;bottom:4px;font-size:10px;color:#8a94ab;opacity:.7}
    .cell.hl { outline:3px solid #fff; outline-offset:-3px; }
    .cell.move-ok { box-shadow:inset 0 0 0 3px rgba(111, 255, 145, .9); cursor:pointer; }
    .cell.move-bad{ box-shadow:inset 0 0 0 3px rgba(255, 111, 111, .7); }
    .cell.target-ok{ box-shadow:inset 0 0 0 3px rgba(255, 215, 111, .9); cursor:pointer; }

    .fort, .piece{width:75%;height:75%;border-radius:50%;display:grid;place-items:center;font-weight:700;color:#0b0f16;border:2px solid rgba(0,0,0,.35);box-shadow:0 6px 12px rgba(0,0,0,.35)}
    .fort{border-radius:12px;width:82%;height:82%;font-weight:800}
    .fort.blue{background:linear-gradient(180deg,#afd3ff,#7ab6ff)}
    .fort.red{background:linear-gradient(180deg,#ffb1b1,#ff7e7e)}
    .piece.blue{background:linear-gradient(180deg,#3c9cff,#2c7be5)}
    .piece.red{background:linear-gradient(180deg,#ff6767,#e55353)}
    .hp{position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);font-size:11px;color:#cfd7ea;background:#121722;border:1px solid #1d2433;border-radius:8px;padding:2px 6px}

    .hand{display:grid;gap:8px}
    .cardui{background:#141a22;border:1px solid #232a3a;border-radius:12px;padding:10px}
    .cardui h4{margin:0 0 6px;font-size:13px}
    .small{font-size:11px;color:var(--muted)}
    .playbtn{margin-top:8px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  </style>
</head>
<body>
  <div class="app">
    <aside class="card">
      <h2>Ã‰tat de la partie</h2>
      <div class="pad">
        <div class="row" style="justify-content:space-between">
          <div class="pill"><strong>Tour:</strong> <span id="turnLabel">0</span></div>
          <button id="btnStart" class="btn primary">DÃ©terminer le 1er joueur</button>
        </div>
        <div class="sep"></div>
        <div class="grid2">
          <div class="cardui">
            <h4>Forteresse ðŸ”µ</h4>
            <div>PV: <span id="blueHP">7</span> (A9)</div>
          </div>
          <div class="cardui">
            <h4>Forteresse ðŸ”´</h4>
            <div>PV: <span id="redHP">7</span> (I1)</div>
          </div>
        </div>
        <div class="sep"></div>
        <div class="grid2">
          <div class="cardui">
            <h4>Phase</h4>
            <div id="phase" class="small">prÃ©paration</div>
          </div>
          <div class="cardui">
            <h4>ImmunitÃ© (tour 1)</h4>
            <div class="small">J1: <span id="im1">âœ”</span> Â· J2: <span id="im2">âœ”</span></div>
          </div>
        </div>
        <div class="sep"></div>
        <div class="cardui">
          <h4>Actions rapides</h4>
          <div class="row">
            <button class="btn" id="btnPlaceTiles">Placer 47 tuiles</button>
            <button class="btn" id="btnReset">RÃ©initialiser</button>
          </div>
        </div>
        <div class="sep"></div>
        <div class="cardui">
          <h4>Journal</h4>
          <div id="log" class="log"></div>
        </div>
      </div>
    </aside>

    <main class="card">
      <h2>Plateau</h2>
      <div class="board-wrap">
        <div id="board"></div>
      </div>
    </main>

    <aside class="card">
      <h2>Main & Pioches</h2>
      <div class="pad">
        <div class="row" style="justify-content:space-between">
          <div class="pill">Joueur actif: <strong id="activePlayer">â€”</strong></div>
          <button id="btnEndTurn" class="btn">Fin de tour</button>
        </div>
        <div class="sep"></div>
        <div class="grid2">
          <div class="cardui">
            <h4>Main (ðŸ”µ)</h4>
            <div id="handBlue" class="hand"></div>
          </div>
          <div class="cardui">
            <h4>Main (ðŸ”´)</h4>
            <div id="handRed" class="hand"></div>
          </div>
        </div>
        <div class="sep"></div>
        <div class="grid3">
          <div class="cardui">
            <h4>Pioches</h4>
            <div class="small">ðŸ”µ: <span id="deckB">â€”</span> Â· ðŸ”´: <span id="deckR">â€”</span></div>
            <div class="small">DÃ©fausses â€” ðŸ”µ: <span id="discB">0</span> Â· ðŸ”´: <span id="discR">0</span></div>
          </div>
          <div class="cardui">
            <h4>Tuiles</h4>
            <div class="small">PlacÃ©es: <span id="tilesCount">0</span> / 47</div>
          </div>
          <div class="cardui">
            <h4>Blocs</h4>
            <div class="small"><span id="blocksActive">0</span> / 6</div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
  // ===== Constantes plateau =====
  const GRID=9, COLS="ABCDEFGHI";
  const forbidden = new Set(["A1","B1","C1","A2","B2","C2","A3","B3","G9","H9","I9","G8","H8","I8","H7","I7"]);
  const valid = new Set([
    "A4","A5","A6","A7","A8",
    "B4","B5","B6","B7","B8","B9",
    "C3","C4","C5","C6","C7","C8","C9",
    "D1","D2","D3","D4","D5","D6","D7","D8","D9",
    "E1","E2","E3","E4","E5","E6","E7","E8","E9",
    "F1","F2","F3","F4","F5","F6","F7","F8","F9",
    "G1","G2","G3","G4","G5","G6","G7",
    "H1","H2","H3","H4","H5","H6",
    "I2","I3","I4","I5","I6"
  ]);
  const ORANGE = new Set(["D5","E4","E5","E6","F5"]);
  const RED_SPAWN = new Set(["G1","G2","G3","H1","H2","H3","I2","I3"]);
  const BLUE_SPAWN= new Set(["A8","A7","B9","B8","B7","C9","C8","C7"]);
  const FORT_BLUE="A9", FORT_RED="I1";

  const $ = (s)=>document.querySelector(s);
  const board=$("#board"), logEl=$("#log");

  const state = {
    turn:0, active:'blue', phase:'prÃ©paration',
    firstTurnMode:true, firstOrder:null, immunity:{p1:true,p2:true},
    blocks:new Set(),
    tiles:{},
    selected:null, // {color,id}
    played:0,
    freeMoveRemaining:0,
    turnRevealedTile:false, // une seule tuile rÃ©vÃ©lÃ©e par tour
    pieces:{
      blue:{fortHP:7, pieces:[], hand:[], deck:[], discard:[]},
      red :{fortHP:7, pieces:[], hand:[], deck:[], discard:[]},
    },
    flags:{},
    input:{ mode:null } // {mode:'MOVE_CARD', remaining, color, handIdx, unitId}
  };

  // ===== Helpers =====
  function toAlg(c,r){ return COLS[c]+(r+1); }
  function fromAlg(a){ return {c:COLS.indexOf(a[0]), r:+a.slice(1)-1}; }
  function log(t){ const p=document.createElement('div'); p.textContent=t; logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }
  function neighbors4(a){ const {c,r}=fromAlg(a); const outs=[]; [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dc,dr])=>{ const nc=c+dc, nr=r+dr; if(nc>=0&&nc<GRID&&nr>=0&&nr<GRID){ const x=toAlg(nc,nr); if(!forbidden.has(x)) outs.push(x); }}); return outs; }
  function isAdjacent4(a,b){ return neighbors4(a).includes(b); }
  function isLOS(a,b){ const A=fromAlg(a), B=fromAlg(b); const dc=Math.sign(B.c-A.c), dr=Math.sign(B.r-A.r);
    if(!(A.c===B.c || A.r===B.r || Math.abs(B.c-A.c)===Math.abs(B.r-A.r))) return false;
    let c=A.c+dc, r=A.r+dr; while(!(c===B.c && r===B.r)){ const x=toAlg(c,r); if(state.blocks.has(x)) return false; if(getPieceAt(x)) return false; c+=dc; r+=dr; } return true; }
  function getPieceAt(c){ for(const color of ['blue','red']){ const u=state.pieces[color].pieces.find(p=>p.cell===c); if(u) return {color,unit:u}; } return null; }
  function findUnit(color,id){ return state.pieces[color].pieces.find(u=>u.id===id); }
  function canStep(from,to){ if(!from||from===to) return false; if(!valid.has(to)||state.blocks.has(to)||getPieceAt(to)) return false; return isAdjacent4(from,to); }

  // ===== Build board =====
  function buildGrid(){
    board.innerHTML='';
    for(let r=GRID-1;r>=0;r--){
      for(let c=0;c<GRID;c++){
        const alg=toAlg(c,r);
        const cell=document.createElement('div'); cell.className='cell '+(forbidden.has(alg)?'invalid':'play'); cell.dataset.coord=alg;
        if(ORANGE.has(alg)) cell.classList.add('orange');
        if(RED_SPAWN.has(alg)) cell.classList.add('rzone');
        if(BLUE_SPAWN.has(alg)) cell.classList.add('bzone');
        const q=document.createElement('div'); q.className='coord'; q.textContent=alg; cell.appendChild(q);
        cell.addEventListener('click', ()=>onCellClick(alg, cell));
        board.appendChild(cell);
      }
    }
  }

  function renderPiecesAndForts(){
    // clear pieces/forts inside cells then re-render
    document.querySelectorAll('.cell').forEach(cell=>{
      [...cell.children].forEach(ch=>{ if(!ch.classList.contains('coord')) ch.remove(); });
      cell.classList.toggle('blocked', state.blocks.has(cell.dataset.coord));
      cell.classList.remove('move-ok','move-bad','target-ok','hl');
    });
    // forts
    for(const [coord, cls, hp] of [[FORT_BLUE,'blue',state.pieces.blue.fortHP],[FORT_RED,'red',state.pieces.red.fortHP]]){
      const cell=document.querySelector(`.cell[data-coord="${coord}"]`); if(!cell) continue;
      const f=document.createElement('div'); f.className=`fort ${cls}`; f.textContent='F';
      const h=document.createElement('div'); h.className='hp'; h.textContent=`${hp} PV`;
      cell.appendChild(f); cell.appendChild(h);
    }
    // pieces
    for(const color of ['blue','red']){
      state.pieces[color].pieces.forEach(u=>{
        if(!u.cell) return;
        const cell=document.querySelector(`.cell[data-coord="${u.cell}"]`); if(!cell) return;
        const p=document.createElement('div'); p.className=`piece ${color}`; p.textContent=u.hp;
        p.title = `${color} ${u.id}`;
        cell.appendChild(p);
      });
    }
  }

  // ===== Decks =====
  function buildDeck26(){
    const deck=[];
    deck.push(...Array(3).fill({t:'MOVE',n:2}));
    deck.push(...Array(3).fill({t:'MOVE',n:3}));
    deck.push(...Array(2).fill({t:'MOVE',n:4}));
    deck.push(...Array(2).fill({t:'MOVE',n:5}));
    deck.push(...Array(6).fill({t:'MELEE_SWAP'}));
    deck.push(...Array(4).fill({t:'RANGE_TP'}));
    deck.push(...Array(3).fill({t:'HEAL_REINFORCE'}));
    deck.push(...Array(3).fill({t:'BLOCK_UNBLOCK'}));
    return deck.map((c,i)=>({...c,id:`C${Math.random().toString(36).slice(2,8)}${i}`}));
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function reshuffleIfNeeded(P){ if(P.deck.length===0 && P.discard.length){ P.deck = shuffle(P.discard.splice(0)); log('ðŸ”„ Re-mÃ©lange de la dÃ©fausse dans la pioche.'); } }
  function draw(color,n){ const P=state.pieces[color]; while(n-->0){ if(P.deck.length===0) reshuffleIfNeeded(P); if(P.deck.length===0) break; P.hand.push(P.deck.pop()); } updateDeckUI(); }
  function drawTo(color,cap){ const P=state.pieces[color]; while(P.hand.length<cap){ if(P.deck.length===0) reshuffleIfNeeded(P); if(P.deck.length===0) break; P.hand.push(P.deck.pop()); } updateDeckUI(); }

  function updateDeckUI(){
    $('#deckB').textContent=state.pieces.blue.deck.length;
    $('#deckR').textContent=state.pieces.red.deck.length;
    $('#discB').textContent=state.pieces.blue.discard.length;
    $('#discR').textContent=state.pieces.red.discard.length;
  }

  // ===== Hands UI =====
  function pretty(c){
    switch(c.t){ case 'MOVE': return `DÃ©placement ${c.n}`;
      case 'MELEE_SWAP': return 'CAC / Ã‰change';
      case 'RANGE_TP': return 'Attaque Ã  distance / TÃ©lÃ©portation';
      case 'HEAL_REINFORCE': return 'Soin / Renfort';
      case 'BLOCK_UNBLOCK': return 'Blocage / DÃ©blocage';
    } return 'Carte';
  }
  function renderHands(){
    function side(color,target){
      const P=state.pieces[color]; target.innerHTML='';
      P.hand.forEach((card,idx)=>{
        const box=document.createElement('div'); box.className='cardui';
        const h=document.createElement('h4'); h.textContent=pretty(card); box.appendChild(h);
        const s=document.createElement('div'); s.className='small'; s.textContent='#'+card.id; box.appendChild(s);
        const b=document.createElement('button'); b.className='btn playbtn'; b.textContent='Jouer';
        if(state.active!==color) b.disabled=true;
        b.addEventListener('click', ()=>playCard(color, idx));
        box.appendChild(b);
        target.appendChild(box);
      });
    }
    side('blue', $('#handBlue')); side('red', $('#handRed'));
  }

  // ===== Init =====
  function initGame(){
    Object.assign(state,{
      turn:0, active:'blue', phase:'prÃ©paration',
      firstTurnMode:true, firstOrder:null, immunity:{p1:true,p2:true},
      blocks:new Set(), tiles:{}, selected:null, played:0, flags:{}, freeMoveRemaining:0, turnRevealedTile:false,
      input:{mode:null}
    });
    state.pieces.blue = {fortHP:7, pieces:[], hand:[], deck:shuffle(buildDeck26()), discard:[]};
    state.pieces.red  = {fortHP:7, pieces:[], hand:[], deck:shuffle(buildDeck26()), discard:[]};
    // 5 pions + 2 rÃ©serve
    shuffle([...BLUE_SPAWN]).slice(0,5).forEach((cell,i)=>state.pieces.blue.pieces.push({id:`B${i+1}`,cell,hp:2}));
    state.pieces.blue.pieces.push({id:'B6',cell:null,hp:2}); state.pieces.blue.pieces.push({id:'B7',cell:null,hp:2});
    shuffle([...RED_SPAWN]).slice(0,5).forEach((cell,i)=>state.pieces.red.pieces.push({id:`R${i+1}`,cell,hp:2}));
    state.pieces.red.pieces.push({id:'R6',cell:null,hp:2}); state.pieces.red.pieces.push({id:'R7',cell:null,hp:2});
    drawTo('blue',5); drawTo('red',5);
    buildGrid(); renderPiecesAndForts(); renderHands(); renderTop();
    log('Nouvelle partie. Place 47 tuiles puis tire le premier joueur.');
  }

  // ===== Tiles (squelette) =====
  function place47(){
    // simple placeholder count for UI (on implÃ©mentera/branchera les effets ensuite si besoin pour le bug MOVE)
    const all=[...valid].filter(c=>!RED_SPAWN.has(c) && !BLUE_SPAWN.has(c) && c!==FORT_BLUE && c!==FORT_RED);
    const chosen=shuffle(all).slice(0,47);
    state.tiles={}; chosen.forEach(c=>state.tiles[c]={key:'ANY',revealed:false});
    renderTop(); log('47 tuiles placÃ©es.');
  }
  function revealTileIfAny(cell,color){
    if(state.turnRevealedTile) return;
    const t=state.tiles[cell]; if(!t || t.revealed) return;
    t.revealed=true; state.turnRevealedTile=true;
    log(`[Tuile] RÃ©vÃ©lÃ©e sur ${cell} (effet non dÃ©taillÃ© dans ce correctif MOVE).`);
  }

  // ===== Selection & clicks =====
  function onCellClick(alg, cellEl){
    // sÃ©lection si on clique sur un pion de l'actif
    const occ=getPieceAt(alg);
    if(occ && occ.color===state.active){
      state.selected={color:occ.color,id:occ.unit.id};
      highlightSelection();
      return;
    }

    // prioritÃ© au mode MOVE_CARD si actif
    if(state.input.mode==='MOVE_CARD'){
      const {unitId, color} = state.input;
      const unit=findUnit(color, unitId);
      if(!unit || !unit.cell) return;
      // autoriser uniquement si la case cliquÃ©e est marquÃ©e move-ok
      if(!cellEl.classList.contains('move-ok')) return;
      // exÃ©cuter un pas
      unit.cell = alg;
      revealTileIfAny(alg, color);
      state.input.remaining--;
      log(`DÃ©placement carte: ${unit.id} â†’ ${alg} (reste ${state.input.remaining}).`);
      if(state.input.remaining<=0){
        // fin de l'action MOVE
        commitCardMove();
      }else{
        // re-calcul des voisins valides
        highlightMoveTargets(unit.cell);
      }
      renderPiecesAndForts();
      return;
    }

    // sinon : dÃ©placement gratuit (1 pas) si sÃ©lection et crÃ©dit > 0
    if(state.selected && state.freeMoveRemaining>0){
      const sel=findUnit(state.selected.color, state.selected.id);
      if(sel && canStep(sel.cell, alg)){
        sel.cell=alg; state.freeMoveRemaining--; revealTileIfAny(alg, state.active);
        log(`Pas gratuit: ${sel.id} â†’ ${alg}.`);
        renderPiecesAndForts();
      }
      return;
    }
  }

  function clearHighlights(){
    document.querySelectorAll('.cell').forEach(c=>c.classList.remove('move-ok','move-bad','target-ok','hl'));
  }
  function highlightSelection(){
    clearHighlights();
    if(!state.selected) return;
    const sel=findUnit(state.selected.color, state.selected.id);
    if(!sel || !sel.cell) return;
    const cell=document.querySelector(`.cell[data-coord="${sel.cell}"]`);
    if(cell) cell.classList.add('hl');
  }
  function highlightMoveTargets(from){
    clearHighlights();
    const neigh=neighbors4(from);
    neigh.forEach(coord=>{
      const cell=document.querySelector(`.cell[data-coord="${coord}"]`);
      if(!cell) return;
      if(canStep(from,coord)) cell.classList.add('move-ok'); else cell.classList.add('move-bad');
    });
    const here=document.querySelector(`.cell[data-coord="${from}"]`); if(here) here.classList.add('hl');
  }

  // ===== Cards =====
  function playCard(color, idx){
    if(state.active!==color){ log('Pas votre tour.'); return; }
    const card=state.pieces[color].hand[idx];
    switch(card.t){
      case 'MOVE': return playMoveCard(color, idx, card.n);
      default: log('Seule la carte DÃ©placement est pertinente pour ce correctif.'); break;
    }
  }

  function playMoveCard(color, handIdx, steps){
    if(!state.selected){ log('SÃ©lectionnez d\'abord un pion.'); return; }
    const unit=findUnit(state.selected.color, state.selected.id);
    if(!unit||!unit.cell){ log('Pion hors plateau.'); return; }
    state.input={mode:'MOVE_CARD', remaining:steps, color, handIdx, unitId:unit.id};
    highlightMoveTargets(unit.cell);
    log(`Carte DÃ©placement ${steps}: cliquez case par case parmi les surbrillances vertes.`);
  }

  function commitCardMove(){
    const {color, handIdx} = state.input;
    const P=state.pieces[color];
    const [c]=P.hand.splice(handIdx,1);
    if(c) P.discard.push(c);
    state.played++;
    state.input={mode:null};
    clearHighlights();
    renderHands(); updateDeckUI();
  }

  // ===== UI Top =====
  function renderTop(){
    $('#turnLabel').textContent=state.turn;
    $('#activePlayer').textContent=(state.active==='blue'?'ðŸ”µ Bleu':'ðŸ”´ Rouge');
    $('#phase').textContent=state.phase;
    $('#blueHP').textContent=state.pieces.blue.fortHP;
    $('#redHP').textContent=state.pieces.red.fortHP;
    $('#im1').textContent=state.immunity.p1?'âœ”':'â€”';
    $('#im2').textContent=state.immunity.p2?'âœ”':'â€”';
    $('#tilesCount').textContent=Object.keys(state.tiles).length;
    $('#blocksActive').textContent=state.blocks.size;
  }

  // ===== Buttons =====
  $('#btnPlaceTiles').addEventListener('click', place47);
  $('#btnReset').addEventListener('click', initGame);
  $('#btnEndTurn').addEventListener('click', ()=>{
    // simple tour flip + reset flags pour ce correctif
    state.turn++;
    state.active=(state.active==='blue'?'red':'blue');
    state.freeMoveRemaining=1; state.turnRevealedTile=false; state.played=0; state.flags={}; state.input={mode:null};
    clearHighlights();
    renderTop(); renderPiecesAndForts(); renderHands();
  });
  $('#btnStart').addEventListener('click', ()=>{
    const rB=((Math.random()*6)|0)+1, rR=((Math.random()*6)|0)+1;
    const first = rB===rR ? (Math.random()<.5?'blue':'red') : (rB>rR?'blue':'red');
    state.firstOrder=first; state.active=first; state.phase='actions'; state.freeMoveRemaining=1;
    log(`Jet ðŸ”µ=${rB}, ðŸ”´=${rR}. ${first==='blue'?'Bleu':'Rouge'} commence.`);
    renderTop();
  });

  // Start
  initGame();
  </script>
</body>
</html>
